// TradeFeed — Prisma Schema
// Multi-tenant SaaS for SA wholesalers & retailers
// 
// RULES:
// - Every tenant-scoped model has a `shopId` field
// - All queries MUST filter by shopId (enforced in data access layer)
// - Prices stored as integers (cents) — ZAR only
// - WhatsApp numbers are PII (POPIA) — handle with care
// - No cross-tenant data leakage

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// TENANT: Shop
// The core tenant entity. Everything belongs to a Shop.
// ============================================================
model Shop {
  id          String   @id @default(cuid())
  name        String                          // Shop display name (e.g. "Marble Tower Fashions")
  slug        String   @unique                // URL-safe identifier for public catalog (e.g. "marble-tower-fashions")
  description String?                         // Optional shop description
  whatsappNumber String                       // Shop's WhatsApp number for orders (PII — POPIA)
  logoUrl     String?                         // Shop logo image URL (stored externally, not in DB)
  bannerUrl   String?                         // Shop banner/cover image URL
  isActive    Boolean  @default(true)         // Soft-disable without deleting
  isVerified  Boolean  @default(false)        // Admin-verified seller badge
  isFeaturedShop Boolean @default(false)      // Admin-featured on marketplace

  // ── Location ─────────────────────────────────────────
  address     String?                         // Street address (e.g. "Shop 42, Marble Tower")
  city        String?                         // City (e.g. "Johannesburg")
  province    String?                         // Province (e.g. "Gauteng")
  latitude    Float?                          // GPS latitude for map pin
  longitude   Float?                          // GPS longitude for map pin

  // ── Profile ──────────────────────────────────────────
  aboutText   String?                         // Extended about/bio for seller profile
  businessHours String?                       // JSON string: {"mon":"08:00-17:00", ...}
  instagram   String?                         // Instagram handle (without @)
  facebook    String?                         // Facebook page URL or username
  tiktok      String?                         // TikTok handle (without @)
  website     String?                         // External website URL

  // ── Referral ─────────────────────────────────────────
  referralCode  String?  @unique              // Auto-generated referral code (e.g. "TF-ABC123")
  referredBy    String?                       // Slug of the shop that referred this seller

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users       ShopUser[]                      // Users linked to this shop
  products    Product[]                       // Products belonging to this shop
  categories  Category[]                      // Product categories for this shop
  subscription Subscription?                  // Current billing subscription
  promotedListings PromotedListing[]          // Marketplace promoted listings
  orders      Order[]                         // Orders placed at this shop
  reviews     Review[]                        // Reviews for this shop's products

  @@index([slug])
  @@index([isActive])
  @@index([isFeaturedShop])
  @@index([referralCode])
}

// ============================================================
// USER: Synced from Clerk via webhook
// A user can belong to ONE shop (MVP). 
// ShopUser join table enforces role-based access.
// ============================================================
model User {
  id            String   @id @default(cuid())
  clerkId       String   @unique              // Clerk external user ID
  email         String   @unique
  firstName     String?
  lastName      String?
  imageUrl      String?

  // Admin moderation
  isBanned      Boolean  @default(false)      // Platform-wide ban
  bannedReason  String?                       // Why the user was banned
  bannedAt      DateTime?                     // When the ban was applied
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  shops         ShopUser[]                    // Shops this user belongs to

  @@index([clerkId])
}

// ============================================================
// SHOP-USER: Join table with role
// Enforces which users can access which shops and what they can do.
// MVP: One user → one shop. Schema supports future multi-shop.
// ============================================================
model ShopUser {
  id     String   @id @default(cuid())
  role   UserRole @default(STAFF)             // What this user can do in this shop

  userId String
  shopId String

  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  shop   Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // A user can only have one role per shop
  @@unique([userId, shopId])
  @@index([shopId])
  @@index([userId])
}

// ============================================================
// ROLE: Controls access level within a shop
// OWNER  — Full access, billing, delete shop
// MANAGER — Product CRUD, stock management
// STAFF   — View-only, limited actions
// ============================================================
enum UserRole {
  OWNER
  MANAGER
  STAFF
}

// ============================================================
// CATEGORY: Product categories per shop
// Tenant-scoped — each shop has its own categories.
// ============================================================
model Category {
  id       String @id @default(cuid())
  name     String                             // e.g. "Dresses", "T-Shirts", "Jeans"
  slug     String                             // URL-safe (unique within shop)
  
  shopId   String
  shop     Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Category slug must be unique within a shop
  @@unique([shopId, slug])
  @@index([shopId])
}

// ============================================================
// PRODUCT: Core commerce entity
// Always scoped to a shopId. Never query without shopId filter.
// ============================================================
model Product {
  id          String  @id @default(cuid())
  name        String                          // e.g. "Floral Summer Dress"
  description String?                         // Product description
  isActive    Boolean @default(true)          // Controls visibility on public catalog

  // Admin moderation
  isFlagged   Boolean @default(false)          // Flagged for policy violation
  flagReason  String?                          // Why it was flagged
  flaggedAt   DateTime?                        // When it was flagged

  shopId      String
  shop        Shop    @relation(fields: [shopId], references: [id], onDelete: Cascade)

  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  globalCategoryId String?                    // Platform-wide marketplace category
  globalCategory   GlobalCategory? @relation(fields: [globalCategoryId], references: [id], onDelete: SetNull)

  // ── Dynamic Variant Labels ───────────────────────────
  // What do the variant axes mean for THIS product?
  // Clothing: "Size" / "Color" (default)
  // Electronics: "Storage" / "Color"
  // Food: "Weight" / "Flavor"
  // Existing data defaults to "Size"/"Color" — zero migration risk.
  option1Label  String  @default("Size")      // Label for variant.size column
  option2Label  String  @default("Color")     // Label for variant.color column

  // ── Denormalized Price Range ─────────────────────────
  // Computed from active variants. Updated on variant create/update/delete.
  // Enables efficient price sorting on marketplace queries.
  minPriceCents Int     @default(0)            // Cheapest active variant price
  maxPriceCents Int     @default(0)            // Most expensive active variant price

  // Relations
  images      ProductImage[]                  // Product images (URLs only)
  variants    ProductVariant[]                // Product variants with stock
  promotedListings PromotedListing[]          // Marketplace promotions for this product

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([shopId])
  @@index([shopId, isActive])
  @@index([categoryId])
  @@index([globalCategoryId])
}

// ============================================================
// PRODUCT IMAGE: External image URLs for a product
// Stored externally (Uploadthing/Cloudinary). DB holds URL only.
// ============================================================
model ProductImage {
  id        String @id @default(cuid())
  url       String                            // CDN image URL (Uploadthing)
  key       String?                           // Uploadthing file key (for deletion)
  altText   String?                           // Accessibility alt text
  position  Int    @default(0)                // Display order (0 = primary)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([productId])
}

// ============================================================
// PRODUCT VARIANT: Size + Color combinations with pricing & stock
// This is the buyable unit. A product has multiple variants.
// e.g. "Floral Dress" → [S/Red, M/Red, L/Red, S/Blue, M/Blue, L/Blue]
// 
// Price is per variant (wholesalers may price by size).
// Stock is per variant.
// ============================================================
model ProductVariant {
  id           String @id @default(cuid())
  size         String                         // e.g. "S", "M", "L", "XL", "2XL", "30", "32"
  color        String?                        // e.g. "Red", "Blue" — optional for some products
  priceInCents Int                            // Price in ZAR cents (e.g. 29999 = R299.99)
  stock        Int    @default(0)             // Current stock count for this variant
  sku          String?                        // Optional SKU for seller's own tracking
  isActive     Boolean @default(true)         // Can hide individual variants

  productId    String
  product      Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // A product can't have duplicate size+color combinations
  @@unique([productId, size, color])
  @@index([productId])
  @@index([productId, isActive])
  @@index([productId, stock])
}

// ============================================================
// ANALYTICS EVENT: Lightweight page view + click tracking
// Tracks catalog views, product views, and WhatsApp clicks.
// ============================================================
model AnalyticsEvent {
  id        String   @id @default(cuid())
  type      EventType                        // PAGE_VIEW, PRODUCT_VIEW, WHATSAPP_CLICK
  shopId    String                           // Tenant scope
  productId String?                          // Optional — null for catalog-level events
  
  // Visitor metadata (no PII — just anonymised fingerprint)
  visitorId String?                          // Hashed IP or anonymous session ID
  userAgent String?                          // Browser user-agent (for device stats)
  referrer  String?                          // Where the visitor came from

  createdAt DateTime @default(now())

  @@index([shopId, type, createdAt])
  @@index([shopId, productId, type])
  @@index([createdAt])
  @@index([visitorId])
}

enum EventType {
  PAGE_VIEW                                  // Catalog page view
  PRODUCT_VIEW                               // Individual product detail view
  WHATSAPP_CLICK                             // WhatsApp order/enquiry button tap
  WHATSAPP_CHECKOUT                          // Cart checkout via WhatsApp
  MARKETPLACE_VIEW                           // Marketplace page view
  MARKETPLACE_CLICK                          // Click from marketplace to product/shop
  PROMOTED_IMPRESSION                        // Promoted listing rendered on screen
  PROMOTED_CLICK                             // Click on a promoted listing
}

// ============================================================
// SUBSCRIPTION PLAN: Defines available plans + features
// Phase 5 — PayFast billing.
// ============================================================
model Plan {
  id             String   @id @default(cuid())
  name           String                      // "Free", "Pro", "Business"
  slug           String   @unique            // "free", "pro", "business"
  priceInCents   Int      @default(0)        // Monthly price in ZAR cents (0 = free)
  productLimit   Int      @default(10)       // Max products (0 = unlimited)
  features       String?                     // JSON array of feature strings
  isActive       Boolean  @default(true)

  subscriptions  Subscription[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// ============================================================
// SUBSCRIPTION: Links a shop to a plan with billing state
// ============================================================
model Subscription {
  id              String             @id @default(cuid())
  status          SubscriptionStatus @default(ACTIVE)

  shopId          String             @unique     // One subscription per shop
  shop            Shop               @relation(fields: [shopId], references: [id], onDelete: Cascade)

  planId          String
  plan            Plan               @relation(fields: [planId], references: [id])

  // PayFast billing
  payfastToken    String?                        // PayFast subscription token (for cancellations)
  currentPeriodStart DateTime @default(now())
  currentPeriodEnd   DateTime?                   // null = no expiry (free plan)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([shopId])
  @@index([planId])
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  TRIALING
}

// ============================================================
// GLOBAL CATEGORY: Platform-wide categories for marketplace
// Not per-shop — managed by platform admin.
// Self-referential parentId for subcategories.
// Generic naming: works for clothing now, any industry later.
// ============================================================
model GlobalCategory {
  id           String  @id @default(cuid())
  name         String                          // e.g. "Hoodies & Sweaters", "Sneakers"
  slug         String  @unique                 // URL-safe: "hoodies-sweaters"
  description  String?                         // Optional description for SEO
  icon         String?                         // Emoji or icon identifier
  imageUrl     String?                         // Category hero/banner image
  displayOrder Int     @default(0)             // Sort order in UI
  isActive     Boolean @default(true)          // Hide without deleting

  // Self-referential: parent → children (subcategories)
  parentId     String?
  parent       GlobalCategory?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children     GlobalCategory[] @relation("CategoryTree")

  // Products mapped to this category
  products     Product[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([parentId])
  @@index([isActive, displayOrder])
}

// ============================================================
// PROMOTED LISTING: Sellers pay to boost products on marketplace
// Tiers: BOOST (R49/wk), FEATURED (R149/wk), SPOTLIGHT (R399/wk)
// ============================================================
model PromotedListing {
  id              String               @id @default(cuid())
  tier            PromotionTier                   // BOOST, FEATURED, SPOTLIGHT
  status          PromotedListingStatus @default(ACTIVE)

  shopId          String
  shop            Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Scheduling
  startsAt        DateTime @default(now())        // When promotion begins
  expiresAt       DateTime                        // When promotion ends

  // Performance tracking
  impressions     Int      @default(0)            // Times shown on marketplace
  clicks          Int      @default(0)            // Times clicked

  // Payment
  amountPaidCents Int      @default(0)            // Amount paid in ZAR cents
  payfastPaymentId String?                        // PayFast payment reference

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status, expiresAt])                    // Active + not expired queries
  @@index([shopId])
  @@index([productId])
  @@index([tier, status])
}

enum PromotionTier {
  BOOST                                           // R49/wk — feed placement with "Sponsored" label
  FEATURED                                        // R149/wk — carousel + priority feed + badge
  SPOTLIGHT                                       // R399/wk — top of marketplace + carousel + badge
}

enum PromotedListingStatus {
  ACTIVE                                          // Currently running
  EXPIRED                                         // Past expiresAt date
  CANCELLED                                       // Manually cancelled or refunded
}

// ============================================================
// ORDER: Tracks WhatsApp checkout orders
// Created when a buyer sends a WhatsApp order from the cart.
// Gives sellers visibility into what was ordered.
//
// FLOW: Cart → Validate stock → Create order → Open WhatsApp
// STATUS: PENDING → CONFIRMED → SHIPPED → DELIVERED (or CANCELLED)
// ============================================================
model Order {
  id              String       @id @default(cuid())
  orderNumber     String       @unique              // Human-readable: "TF-20260224-A1B2"
  status          OrderStatus  @default(PENDING)

  shopId          String
  shop            Shop         @relation(fields: [shopId], references: [id], onDelete: Cascade)

  // Buyer info (captured at checkout — no account needed)
  buyerName       String?                           // Optional buyer name
  buyerPhone      String?                           // WhatsApp number used for order (PII — POPIA)
  buyerNote       String?                           // Optional note from buyer

  // Delivery address (optional — captured at checkout)
  deliveryAddress  String?                           // Street address line
  deliveryCity     String?                           // City
  deliveryProvince String?                           // Province (e.g. "Gauteng")
  deliveryPostalCode String?                         // Postal/ZIP code

  // Totals (snapshot at order time — prices may change later)
  totalCents      Int                               // Total order value in ZAR cents
  itemCount       Int                               // Total quantity of items

  // WhatsApp tracking
  whatsappSent    Boolean      @default(true)       // Whether WA message was opened
  whatsappMessage String?                           // Snapshot of the order message sent

  // Relations
  items           OrderItem[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([shopId, status])
  @@index([shopId, createdAt])
  @@index([orderNumber])
}

// ============================================================
// ORDER ITEM: Individual line items in an order
// Snapshots product/variant info at time of order (prices don't change)
// ============================================================
model OrderItem {
  id              String  @id @default(cuid())

  orderId         String
  order           Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId       String                            // Reference to product (may be deleted later)
  variantId       String                            // Reference to variant (may be deleted later)

  // Snapshot fields — preserved even if product/variant is deleted
  productName     String                            // e.g. "Floral Summer Dress"
  option1Label    String  @default("Size")          // e.g. "Size", "Storage"
  option1Value    String                            // e.g. "M", "128GB"
  option2Label    String  @default("Color")         // e.g. "Color", "Flavor"
  option2Value    String?                           // e.g. "Red" — nullable

  priceInCents    Int                               // Price per unit at order time
  quantity        Int                               // How many ordered

  createdAt       DateTime @default(now())

  @@index([orderId])
  @@index([productId])
}

enum OrderStatus {
  PENDING                                           // Order placed, awaiting seller confirmation
  CONFIRMED                                         // Seller confirmed — preparing order
  SHIPPED                                           // Order dispatched / ready for collection
  DELIVERED                                         // Buyer received order
  CANCELLED                                         // Order cancelled by buyer or seller
}

// ============================================================
// WISHLIST ITEM: Buyer favourites (optional — logged-in buyers)
// Phase 9 — saved products for later.
// Uses visitorId (hashed) for anonymous, userId for logged-in.
// ============================================================
model WishlistItem {
  id         String  @id @default(cuid())
  
  productId  String
  shopId     String                                 // Denormalised for fast queries

  // Visitor tracking (anonymous buyers)
  visitorId  String?                                // Hashed IP/fingerprint for anonymous
  userId     String?                                // Clerk userId for logged-in buyers

  createdAt  DateTime @default(now())

  @@unique([productId, visitorId])                  // One wishlist entry per product per visitor
  @@unique([productId, userId])                     // One wishlist entry per product per user
  @@index([visitorId])
  @@index([userId])
  @@index([shopId])
}

// ============================================================
// REVIEW: Buyer reviews & ratings for products
// Phase 10 — buyers can rate and review products after purchase.
// Reviews require seller approval before they appear publicly.
// ============================================================
model Review {
  id          String   @id @default(cuid())
  rating      Int                                   // 1-5 star rating
  title       String?                               // Optional review title
  comment     String?                               // Review text body

  shopId      String                                // Tenant scope
  shop        Shop     @relation(fields: [shopId], references: [id])
  productId   String                                // Which product was reviewed

  // Buyer info (no account required — like orders)
  buyerName   String                                // Reviewer display name
  buyerEmail  String?                               // Optional email for follow-up

  // Moderation
  isApproved  Boolean  @default(true)               // Auto-approved; seller can delete unwanted reviews
  isVerified  Boolean  @default(false)              // Whether buyer actually purchased

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([shopId])
  @@index([productId, isApproved])
  @@index([shopId, isApproved])
  @@index([productId, rating])
}

// ============================================================
// NOTIFICATION PREFERENCE: Per-shop email notification settings
// Controls which events trigger email notifications.
// ============================================================
model NotificationPreference {
  id                    String  @id @default(cuid())
  shopId                String  @unique              // One pref record per shop

  // What to notify about
  orderNotifications    Boolean @default(true)       // New order placed
  lowStockAlerts        Boolean @default(true)       // Stock drops below threshold
  reviewNotifications   Boolean @default(true)       // New review submitted

  // Thresholds
  lowStockThreshold     Int     @default(5)          // Alert when variant stock <= this

  // Override email (defaults to shop owner's email if null)
  notificationEmail     String?                      // Custom email for notifications

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([shopId])
}

// ============================================================
// BULK IMPORT JOB: Track CSV import progress
// Created when a seller uploads a CSV file for bulk product import.
// ============================================================
model BulkImportJob {
  id            String           @id @default(cuid())
  shopId        String
  fileName      String                               // Original CSV filename
  status        BulkImportStatus @default(PROCESSING)
  totalRows     Int              @default(0)          // Total rows in CSV
  successCount  Int              @default(0)          // Successfully imported
  errorCount    Int              @default(0)          // Failed rows
  errors        String?                               // JSON array of error details
  completedAt   DateTime?                             // When processing finished

  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@index([shopId])
  @@index([shopId, status])
}

enum BulkImportStatus {
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================================
// ADMIN AUDIT LOG: Track all admin actions for accountability
// Records who did what, when, and to which entity.
// ============================================================
model AdminAuditLog {
  id          String   @id @default(cuid())
  adminId     String                               // Clerk user ID of the admin
  adminEmail  String                               // Email snapshot for readability
  action      String                               // e.g. "VERIFY_SHOP", "BAN_USER", "FLAG_PRODUCT"
  entityType  String                               // e.g. "Shop", "User", "Product", "Category"
  entityId    String                               // ID of the affected entity
  entityName  String?                              // Human-readable name snapshot
  details     String?                              // JSON with extra context / before-after
  
  createdAt   DateTime @default(now())

  @@index([adminId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
}
