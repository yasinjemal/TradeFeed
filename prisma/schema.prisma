// TradeFeed — Prisma Schema
// Multi-tenant SaaS for SA clothing wholesalers
// 
// RULES:
// - Every tenant-scoped model has a `shopId` field
// - All queries MUST filter by shopId (enforced in data access layer)
// - Prices stored as integers (cents) — ZAR only
// - WhatsApp numbers are PII (POPIA) — handle with care
// - No cross-tenant data leakage

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// TENANT: Shop
// The core tenant entity. Everything belongs to a Shop.
// ============================================================
model Shop {
  id          String   @id @default(cuid())
  name        String                          // Shop display name (e.g. "Marble Tower Fashions")
  slug        String   @unique                // URL-safe identifier for public catalog (e.g. "marble-tower-fashions")
  description String?                         // Optional shop description
  whatsappNumber String                       // Shop's WhatsApp number for orders (PII — POPIA)
  logoUrl     String?                         // Shop logo image URL (stored externally, not in DB)
  bannerUrl   String?                         // Shop banner/cover image URL
  isActive    Boolean  @default(true)         // Soft-disable without deleting
  isVerified  Boolean  @default(false)        // Admin-verified seller badge

  // ── Location ─────────────────────────────────────────
  address     String?                         // Street address (e.g. "Shop 42, Marble Tower")
  city        String?                         // City (e.g. "Johannesburg")
  province    String?                         // Province (e.g. "Gauteng")
  latitude    Float?                          // GPS latitude for map pin
  longitude   Float?                          // GPS longitude for map pin

  // ── Profile ──────────────────────────────────────────
  aboutText   String?                         // Extended about/bio for seller profile
  businessHours String?                       // JSON string: {"mon":"08:00-17:00", ...}
  instagram   String?                         // Instagram handle (without @)
  facebook    String?                         // Facebook page URL or username
  tiktok      String?                         // TikTok handle (without @)
  website     String?                         // External website URL

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users       ShopUser[]                      // Users linked to this shop
  products    Product[]                       // Products belonging to this shop
  categories  Category[]                      // Product categories for this shop

  @@index([slug])
  @@index([isActive])
}

// ============================================================
// USER: Synced from Clerk via webhook
// A user can belong to ONE shop (MVP). 
// ShopUser join table enforces role-based access.
// ============================================================
model User {
  id            String   @id @default(cuid())
  clerkId       String   @unique              // Clerk external user ID
  email         String   @unique
  firstName     String?
  lastName      String?
  imageUrl      String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  shops         ShopUser[]                    // Shops this user belongs to

  @@index([clerkId])
}

// ============================================================
// SHOP-USER: Join table with role
// Enforces which users can access which shops and what they can do.
// MVP: One user → one shop. Schema supports future multi-shop.
// ============================================================
model ShopUser {
  id     String   @id @default(cuid())
  role   UserRole @default(STAFF)             // What this user can do in this shop

  userId String
  shopId String

  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  shop   Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // A user can only have one role per shop
  @@unique([userId, shopId])
  @@index([shopId])
  @@index([userId])
}

// ============================================================
// ROLE: Controls access level within a shop
// OWNER  — Full access, billing, delete shop
// MANAGER — Product CRUD, stock management
// STAFF   — View-only, limited actions
// ============================================================
enum UserRole {
  OWNER
  MANAGER
  STAFF
}

// ============================================================
// CATEGORY: Product categories per shop
// Tenant-scoped — each shop has its own categories.
// ============================================================
model Category {
  id       String @id @default(cuid())
  name     String                             // e.g. "Dresses", "T-Shirts", "Jeans"
  slug     String                             // URL-safe (unique within shop)
  
  shopId   String
  shop     Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Category slug must be unique within a shop
  @@unique([shopId, slug])
  @@index([shopId])
}

// ============================================================
// PRODUCT: Core commerce entity
// Always scoped to a shopId. Never query without shopId filter.
// ============================================================
model Product {
  id          String  @id @default(cuid())
  name        String                          // e.g. "Floral Summer Dress"
  description String?                         // Product description
  isActive    Boolean @default(true)          // Controls visibility on public catalog

  shopId      String
  shop        Shop    @relation(fields: [shopId], references: [id], onDelete: Cascade)

  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Relations
  images      ProductImage[]                  // Product images (URLs only)
  variants    ProductVariant[]                // Size/color variants with stock

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([shopId])
  @@index([shopId, isActive])
  @@index([categoryId])
}

// ============================================================
// PRODUCT IMAGE: External image URLs for a product
// Stored externally (Uploadthing/Cloudinary). DB holds URL only.
// ============================================================
model ProductImage {
  id        String @id @default(cuid())
  url       String                            // External image URL
  altText   String?                           // Accessibility alt text
  position  Int    @default(0)                // Display order (0 = primary)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([productId])
}

// ============================================================
// PRODUCT VARIANT: Size + Color combinations with pricing & stock
// This is the buyable unit. A product has multiple variants.
// e.g. "Floral Dress" → [S/Red, M/Red, L/Red, S/Blue, M/Blue, L/Blue]
// 
// Price is per variant (wholesalers may price by size).
// Stock is per variant.
// ============================================================
model ProductVariant {
  id           String @id @default(cuid())
  size         String                         // e.g. "S", "M", "L", "XL", "2XL", "30", "32"
  color        String?                        // e.g. "Red", "Blue" — optional for some products
  priceInCents Int                            // Price in ZAR cents (e.g. 29999 = R299.99)
  stock        Int    @default(0)             // Current stock count for this variant
  sku          String?                        // Optional SKU for seller's own tracking
  isActive     Boolean @default(true)         // Can hide individual variants

  productId    String
  product      Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // A product can't have duplicate size+color combinations
  @@unique([productId, size, color])
  @@index([productId])
  @@index([productId, isActive])
}
